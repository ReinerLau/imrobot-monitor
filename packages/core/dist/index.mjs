import{getTimestamp as O,global as g,reportData as k}from"@imrobot/monitor-helpers";import{io as M}from"socket.io-client";import{getTimestamp as R,reportData as l}from"@imrobot/monitor-helpers";import x from"error-stack-parser";import q from"md5";var f=new Set;var a=e=>q(e);function i(e){return f.has(e)?!0:(f.add(e),!1)}var d=e=>{let{fileName:o,columnNumber:t,lineNumber:r}=x.parse(e)[0],n={fileName:o,url:location.href,message:e.message,lineNumber:r,columnNumber:t,time:R()},s=a(`${n.message}-${n.url}-${n.lineNumber}-${n.columnNumber}`);i(s)||l("/error/code",n)},v=({src:e,localName:o,href:t})=>{let r={url:location.href,source:e||t,target:o,time:R()},n=a(`${r.source}-${r.url}-${r.target}`);i(n)||l("/error/resource",r)},T=e=>{if(e.reason.name==="AxiosError")return;let{fileName:o,columnNumber:t,lineNumber:r}=x.parse(e.reason)[0],n={fileName:o,url:location.href,message:e.reason.message,lineNumber:r,columnNumber:t,time:R()},s=a(`${n.message}-${n.url}-${n.columnNumber}`);i(s)||l("/error/code",n)},H=e=>{let{url:o,sendTime:t,status:r,elapsedTime:n,response:s,requestData:u,method:$}=e;if(r===0||r>=400){let p={url:location.href,requestURL:o,time:t,status:r,response:s,elapsedTime:n,method:$,requestData:u},w=a(`${p.response}-${p.method}-${p.status}`);i(w)||l("/error/request",p)}};import{getTimestamp as D}from"@imrobot/monitor-helpers";var b=()=>{P(),S()},P=()=>{let e=XMLHttpRequest.prototype,o=e.open;e.open=function(...t){let r=this;r.data={method:t[0],url:t[1],sendTime:D()},o.apply(r,t)}},S=()=>{let e=XMLHttpRequest.prototype,o=e.send;e.send=function(...t){let r=this;r.data.requestData=t[0],r.addEventListener("loadend",()=>{let{responseType:n,response:s,status:u}=r;["","json","text"].includes(n)&&(r.data.response=s,r.data.status=u,r.data.elapsedTime=new Date(D()).getTime()-new Date(r.data.sendTime).getTime()),c("xhr",r.data)}),o.apply(r,t)}};var h={},j={vue:e=>C(e),error:()=>J(),unhandledrejection:()=>V(),xhr:()=>b()},m=(e,o,t)=>{if(e in h)return!1;h[e]=o;let r=j[e];return t?r&&r(t):r&&r(),!0},c=(e,...o)=>{let t=h[e];t&&t(...o)},C=e=>{e.config.errorHandler=o=>{c("vue",o)}},J=()=>{window.addEventListener("error",e=>c("error",e),!0)},V=()=>{window.addEventListener("unhandledrejection",e=>c("unhandledrejection",e))},U=[],A=e=>{U.push(e)},y=e=>{U.forEach(o=>{o(e)})},E=[];var I=(e,o={})=>{W(o),m("vue",t=>{d(t)},e),m("error",t=>{let r=t.target;r!=null&&r.localName?v(r):d(t.error)}),m("unhandledrejection",t=>{T(t)}),m("xhr",t=>{H(t)}),B(),F()},L=O();function F(){let e=M(g.baseURL);e.on("report",z),window.addEventListener("blur",()=>{e.close()}),window.addEventListener("focus",()=>{e.connect()})}function W(e){g.baseURL=e.baseURL||g.baseURL}function z(){let e=O();k("/api",{time:e,startTime:L}),L=e,y(e)}function B(){E.forEach(e=>{e()})}var X=(e,o)=>{E.push(()=>e.install(o)),e.afterEvent&&A(e.afterEvent)};var G={install:I,use:X},Te=G;export{Te as default};
//# sourceMappingURL=index.mjs.map