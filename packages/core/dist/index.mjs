import{EventTypes as d,getTimestamp as X,global as x,reportData as W}from"@imrobot/shared";import{io as z}from"socket.io-client";import{ErrorEventTypes as l,ErrorTypes as u,getTimestamp as T,reportData as f}from"@imrobot/shared";import D from"error-stack-parser";import P from"md5";var y=new Set;var p=e=>P(e);function c(e){return y.has(e)?!0:(y.add(e),!1)}var v=e=>{let{fileName:o,columnNumber:t,lineNumber:r}=D.parse(e)[0],n={type:l.ERROR,fileName:o,url:location.href,message:e.message,lineNumber:r,columnNumber:t,time:T()},a=p(`${n.type}-${n.message}-${n.url}-${n.columnNumber}`);if(!c(a))return f("/error/code",n),u.CODE},H=({src:e,localName:o,href:t})=>{let r={url:location.href,type:l.RESOURCE,source:e||t,target:o,time:T()},n=p(`${r.type}-${r.source}-${r.url}-${r.target}`);if(!c(n))return f("/error/resource",r),u.RESOURCE},N=e=>{if(e.reason.name==="AxiosError")return;let{fileName:o,columnNumber:t,lineNumber:r}=D.parse(e.reason)[0],n={type:l.UNHANDLEDREJECTION,fileName:o,url:location.href,message:e.reason.message,lineNumber:r,columnNumber:t,time:T()},a=p(`${n.type}-${n.message}-${n.url}-${n.columnNumber}`);if(!c(a))return f("/error/code",n),u.CODE},b=e=>{let{url:o,sendTime:t,status:r,elapsedTime:n,response:a,requestData:h,method:C}=e;if(r===0||r>=400){let i={type:l.XHR,url:location.href,requestURL:o,time:t,status:r,response:a,elapsedTime:n,method:C,requestData:h},q=p(`${i.type}-${i.response}-${i.method}-${i.status}`);if(!c(q))return f("/error/request",i),u.REQUEST}};import{EventTypes as s}from"@imrobot/shared";import{EventTypes as j,getTimestamp as U}from"@imrobot/shared";var O=()=>{J(),k()},J=()=>{let e=XMLHttpRequest.prototype,o=e.open;e.open=function(...t){let r=this;r.data={method:t[0],url:t[1],sendTime:U()},o.apply(r,t)}},k=()=>{let e=XMLHttpRequest.prototype,o=e.send;e.send=function(...t){let r=this;r.data.requestData=t[0],r.addEventListener("loadend",()=>{let{responseType:n,response:a,status:h}=r;["","json","text"].includes(n)&&(r.data.response=a,r.data.status=h,r.data.elapsedTime=new Date(U()).getTime()-new Date(r.data.sendTime).getTime()),m(j.XHR,r.data)}),o.apply(r,t)}};var g={},M={[s.VUE]:e=>V(e),[s.ERROR]:()=>F(),[s.UNHANDLEDREJECTION]:()=>Q(),[s.XHR]:()=>O()},E=(e,o,t)=>{if(e in g)return!1;g[e]=o;let r=M[e];return t?r&&r(t):r&&r(),!0},m=(e,...o)=>{let t=g[e];t&&t(...o)},V=e=>{e.config.errorHandler=o=>{m(s.VUE,o)}},F=()=>{window.addEventListener(s.ERROR,e=>m(s.ERROR,e),!0)},Q=()=>{window.addEventListener(s.UNHANDLEDREJECTION,e=>m(s.UNHANDLEDREJECTION,e))},A=[],L=e=>{A.push(e)},$=e=>{A.forEach(o=>{o(e)})},R=[];var w=(e,o={})=>{G(o),E(d.VUE,t=>{v(t)},e),E(d.ERROR,t=>{let r=t.target;r!=null&&r.localName?H(r):v(t.error)}),E(d.UNHANDLEDREJECTION,t=>{N(t)}),E(d.XHR,t=>{b(t)}),Y(),B()},I=X();function B(){let e=z(x.baseURL);e.on("report",K),window.addEventListener("blur",()=>{e.close()}),window.addEventListener("focus",()=>{e.connect()})}function G(e){x.baseURL=e.baseURL||x.baseURL}function K(){let e=X();W("/api",{time:e,startTime:I}),I=e,$(e)}function Y(){R.forEach(e=>{e()})}var S=(e,o)=>{R.push(()=>e.install(o)),e.afterEvent&&L(e.afterEvent)};import{default as be}from"@imrobot/behavior";import{playScreen as Oe,default as Ae}from"@imrobot/screen";var Z={install:w,use:S},De=Z;export{be as behavior,De as default,Oe as playScreen,Ae as screen};
//# sourceMappingURL=index.mjs.map