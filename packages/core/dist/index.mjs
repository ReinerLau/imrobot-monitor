import{getTimestamp as I,global as b,reportData as W}from"@imrobot/monitor-helpers";import{io as z}from"socket.io-client";import{getTimestamp as R,reportData as f}from"@imrobot/monitor-helpers";import x from"error-stack-parser";import{SourceMapConsumer as C}from"source-map-js";async function N({sourceMap:e,lineNumber:o,columnNumber:t}){let{sourcesContent:r,sources:n}=e,s=(await new C(e)).originalPositionFor({line:o,column:t}),a=n.indexOf(s.source),c=r[a];return{file:s.source,line:s.line,code:P({code:c,line:s.line})}}function P({code:e,line:o,sliceNumber:t=10}){let r=e.split(`
`).map((s,a)=>[a+1,s]),n=o-t>0?o-t:0,i=o+t<=r.length-1?o+t:r.length-1;return r=[...r.slice(n,o),...r.slice(o,i)],JSON.stringify(r)}import q from"md5";var d=new Set;var m=e=>q(e);function p(e){return d.has(e)?!0:(d.add(e),!1)}var h=async e=>{let{fileName:o,columnNumber:t,lineNumber:r}=x.parse(e)[0],i=await(await fetch(`${o}.map`)).json(),s=await N({sourceMap:i,lineNumber:r,columnNumber:t}),a={fileName:s.file,url:location.href,message:e.message,lineNumber:s.line,columnNumber:t,time:R(),code:s.code},c=m(`${a.message}-${a.url}-${a.lineNumber}-${a.columnNumber}`);p(c)||f("/error/code",a)},v=({src:e,localName:o,href:t})=>{let r={url:location.href,source:e||t,target:o,time:R()},n=m(`${r.source}-${r.url}-${r.target}`);p(n)||f("/error/resource",r)},T=e=>{if(e.reason.name==="AxiosError")return;let{fileName:o,columnNumber:t,lineNumber:r}=x.parse(e.reason)[0],n={fileName:o,url:location.href,message:e.reason.message,lineNumber:r,columnNumber:t,time:R()},i=m(`${n.message}-${n.url}-${n.columnNumber}`);p(i)||f("/error/code",n)},H=e=>{let{url:o,sendTime:t,status:r,elapsedTime:n,response:i,requestData:s,method:a}=e;if(r===0||r>=400){let c={url:location.href,requestURL:o,time:t,status:r,response:i,elapsedTime:n,method:a,requestData:s},S=m(`${c.response}-${c.method}-${c.status}`);p(S)||f("/error/request",c)}};import{getTimestamp as y}from"@imrobot/monitor-helpers";var U=()=>{M(),j()},M=()=>{let e=XMLHttpRequest.prototype,o=e.open;e.open=function(...t){let r=this;r.data={method:t[0],url:t[1],sendTime:y()},o.apply(r,t)}},j=()=>{let e=XMLHttpRequest.prototype,o=e.send;e.send=function(...t){let r=this;r.data.requestData=t[0],r.addEventListener("loadend",()=>{let{responseType:n,response:i,status:s}=r;["","json","text"].includes(n)&&(r.data.response=i,r.data.status=s,r.data.elapsedTime=new Date(y()).getTime()-new Date(r.data.sendTime).getTime()),u("xhr",r.data)}),o.apply(r,t)}};var g={},J={vue:e=>V(e),error:()=>k(),unhandledrejection:()=>F(),xhr:()=>U()},l=(e,o,t)=>{if(e in g)return!1;g[e]=o;let r=J[e];return t?r&&r(t):r&&r(),!0},u=(e,...o)=>{let t=g[e];t&&t(...o)},V=e=>{e.config.errorHandler=o=>{u("vue",o)}},k=()=>{window.addEventListener("error",e=>u("error",e),!0)},F=()=>{window.addEventListener("unhandledrejection",e=>u("unhandledrejection",e))},A=[],O=e=>{A.push(e)},L=e=>{A.forEach(o=>{o(e)})},E=[];var X=(e,o={})=>{G(o),l("vue",t=>{h(t)},e),l("error",t=>{let r=t.target;r!=null&&r.localName?v(r):h(t.error)}),l("unhandledrejection",t=>{T(t)}),l("xhr",t=>{H(t)}),Q(),B()},w=I();function B(){let e=z(b.baseURL);e.on("report",K),window.addEventListener("blur",()=>{e.close()}),window.addEventListener("focus",()=>{e.connect()})}function G(e){b.baseURL=e.baseURL||b.baseURL}function K(){let e=I();W("/api",{time:e,startTime:w}),w=e,L(e)}function Q(){E.forEach(e=>{e()})}var $=(e,o)=>{E.push(()=>e.install(o)),e.afterEvent&&O(e.afterEvent)};var Y={install:X,use:$},ye=Y;export{ye as default};
//# sourceMappingURL=index.mjs.map